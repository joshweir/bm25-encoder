'use strict';
Object.defineProperty(exports, '__esModule', { value: true });
exports.BM25Encoder = void 0;
const fs_1 = require('fs');
const types_1 = require('./types');
const tokenizer_1 = require('./tokenizer');
const mm3_1 = require('./mm3');
const stopwords_1 = require('./stopwords');
const punctuation_1 = require('./punctuation');
class BM25Encoder {
  constructor(props) {
    var _a, _b, _c, _d, _e, _f;
    this.props = {
      b: (_a = props === null || props === void 0 ? void 0 : props.b) !== null && _a !== void 0 ? _a : 0.75,
      k1: (_b = props === null || props === void 0 ? void 0 : props.k1) !== null && _b !== void 0 ? _b : 1.2,
      lowerCase:
        (_c = props === null || props === void 0 ? void 0 : props.lowerCase) !== null && _c !== void 0 ? _c : true,
      removePunctuation:
        (_d = props === null || props === void 0 ? void 0 : props.removePunctuation) !== null && _d !== void 0
          ? _d
          : true,
      removeStopwords:
        (_e = props === null || props === void 0 ? void 0 : props.removeStopwords) !== null && _e !== void 0
          ? _e
          : true,
      tokenizer:
        (_f = props === null || props === void 0 ? void 0 : props.tokenizer) !== null && _f !== void 0
          ? _f
          : new tokenizer_1.Tokenizer(),
      docFreq: {},
      nDocs: 0,
      avgdl: 0,
    };
    this.stopwords = (0, stopwords_1.getStopwords)();
    this.punctuation = (0, punctuation_1.getPunctuation)();
  }
  fit(corpus) {
    let nDocs = 0;
    let sumDocLen = 0;
    const docFreqCounter = {};
    for (const doc of corpus) {
      if (typeof doc !== 'string') {
        throw new Error('corpus must be a list of strings');
      }
      const { indices, tf } = this.tf(doc);
      if (indices.length === 0) {
        continue;
      }
      nDocs += 1;
      sumDocLen += tf.reduce((sum, freq) => sum + freq, 0);
      // Count the number of documents that contain each token
      for (const index of indices) {
        docFreqCounter[index] = (docFreqCounter[index] || 0) + 1;
      }
    }
    this.props.docFreq = docFreqCounter;
    this.props.nDocs = nDocs;
    this.props.avgdl = sumDocLen / nDocs;
    return this;
  }
  encode(input) {
    if (!Object.keys(this.props.docFreq).length || !this.props.nDocs || !this.props.avgdl) {
      throw new Error('BM25Encoder has not been fitted yet');
    }
    const { indices, tf: docTf } = this.tf(input);
    const tf = [...docTf];
    const tfSum = tf.reduce((sum, freq) => sum + freq, 0);
    const tfNormed = tf.map(
      (t) => t / (this.props.k1 * (1.0 - this.props.b + this.props.b * (tfSum / this.props.avgdl)) + t),
    );
    return {
      indices,
      values: tfNormed,
    };
  }
  encodeQuery(input) {
    if (!Object.keys(this.props.docFreq).length || !this.props.nDocs || !this.props.avgdl) {
      throw new Error('BM25Encoder has not been fitted yet');
    }
    const { indices, tf: queryTf } = this.tf(input);
    const df = indices.map((idx) => this.props.docFreq[idx] || 1);
    const idf = df.map((d) => Math.log((this.props.nDocs + 1) / (d + 0.5)));
    const idfSum = idf.reduce((sum, val) => sum + val, 0);
    const idfNorm = idf.map((val) => val / idfSum);
    return {
      indices,
      values: idfNorm,
    };
  }
  dump(path) {
    (0, fs_1.writeFileSync)(path, JSON.stringify(this.getParams()));
  }
  load(path) {
    this.setParams(types_1.bm25EncoderSerializedSchema.validateSync(JSON.parse((0, fs_1.readFileSync)(path, 'utf-8'))));
  }
  getParams() {
    if (!Object.keys(this.props.docFreq).length || !this.props.nDocs || !this.props.avgdl) {
      throw new Error('BM25Encoder has not been fitted yet');
    }
    const { tokenizer: _, ...propsExclTokenizer } = this.props;
    return {
      ...propsExclTokenizer,
      docFreq: {
        indices: Object.keys(this.props.docFreq).map(Number),
        values: Object.values(this.props.docFreq),
      },
    };
  }
  setParams(props) {
    this.props = {
      ...this.props,
      ...props,
    };
    return this;
  }
  tf(text) {
    const counts = {};
    const tokens = this.props.tokenizer
      .tokenize(this.props.lowerCase ? text.toLocaleLowerCase() : text)
      .filter((token) => (this.props.removeStopwords ? !this.stopwords.includes(token) : true))
      .filter((token) => (this.props.removePunctuation ? !this.punctuation.includes(token) : true));
    for (const token of tokens) {
      const hashedToken = this.hashText(token);
      counts[hashedToken] = (counts[hashedToken] || 0) + 1;
    }
    const items = Object.entries(counts);
    const indices = items.map(([idx]) => parseInt(idx, 10));
    const tf = Object.values(counts);
    return { indices, tf };
  }
  hashText(token) {
    return (0, mm3_1.mm3)(token);
  }
}
exports.BM25Encoder = BM25Encoder;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYm0yNS1lbmNvZGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2JtMjUtZW5jb2Rlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwyQkFBaUQ7QUFDakQsbUNBS2lCO0FBQ2pCLDJDQUF3QztBQUN4QywrQkFBNEI7QUFDNUIsMkNBQTJDO0FBQzNDLCtDQUErQztBQUUvQyxNQUFhLFdBQVc7SUFLdEIsWUFBWSxLQUFtQzs7UUFDN0MsSUFBSSxDQUFDLEtBQUssR0FBRztZQUNYLENBQUMsRUFBRSxNQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxDQUFDLG1DQUFJLElBQUk7WUFDbkIsRUFBRSxFQUFFLE1BQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLEVBQUUsbUNBQUksR0FBRztZQUNwQixTQUFTLEVBQUUsTUFBQSxLQUFLLGFBQUwsS0FBSyx1QkFBTCxLQUFLLENBQUUsU0FBUyxtQ0FBSSxJQUFJO1lBQ25DLGlCQUFpQixFQUFFLE1BQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLGlCQUFpQixtQ0FBSSxJQUFJO1lBQ25ELGVBQWUsRUFBRSxNQUFBLEtBQUssYUFBTCxLQUFLLHVCQUFMLEtBQUssQ0FBRSxlQUFlLG1DQUFJLElBQUk7WUFDL0MsU0FBUyxFQUFFLE1BQUEsS0FBSyxhQUFMLEtBQUssdUJBQUwsS0FBSyxDQUFFLFNBQVMsbUNBQUksSUFBSSxxQkFBUyxFQUFFO1lBQzlDLE9BQU8sRUFBRSxFQUFFO1lBQ1gsS0FBSyxFQUFFLENBQUM7WUFDUixLQUFLLEVBQUUsQ0FBQztTQUNULENBQUM7UUFDRixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUEsd0JBQVksR0FBRSxDQUFDO1FBQ2hDLElBQUksQ0FBQyxXQUFXLEdBQUcsSUFBQSw0QkFBYyxHQUFFLENBQUM7SUFDdEMsQ0FBQztJQUVELEdBQUcsQ0FBQyxNQUFnQjtRQUNsQixJQUFJLEtBQUssR0FBRyxDQUFDLENB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LENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUNwRTthQUNBLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQ2hCLElBQUksQ0FBQyxLQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FDeEUsQ0FBQztRQUVKLEtBQUssTUFBTSxLQUFLLElBQUksTUFBTSxFQUFFO1lBQzFCLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDekMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztTQUN0RDtRQUVELE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDckMsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN4RCxNQUFNLEVBQUUsR0FBRyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRWpDLE9BQU8sRUFBRSxPQUFPLEVBQUUsRUFBRSxFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVPLFFBQVEsQ0FBQyxLQUFhO1FBQzVCLE9BQU8sSUFBQSxTQUFHLEVBQUMsS0FBSyxDQUFDLENBQUM7SUFDcEIsQ0FBQztDQUNGO0FBcEtELGtDQW9LQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHJlYWRGaWxlU3luYywgd3JpdGVGaWxlU3luYyB9IGZyb20gXCJmc1wiO1xuaW1wb3J0IHtcbiAgQk0yNUVuY29kZXJDb25zdHJ1Y3RvclByb3BzLFxuICBCTTI1RW5jb2RlclByb3BzLFxuICBCTTI1RW5jb2RlclNlcmlhbGl6ZWQsXG4gIGJtMjVFbmNvZGVyU2VyaWFsaXplZFNjaGVtYSxcbn0gZnJvbSBcIi4vdHlwZXNcIjtcbmltcG9ydCB7IFRva2VuaXplciB9IGZyb20gXCIuL3Rva2VuaXplclwiO1xuaW1wb3J0IHsgbW0zIH0gZnJvbSBcIi4vbW0zXCI7XG5pbXBvcnQgeyBnZXRTdG9wd29yZHMgfSBmcm9tIFwiLi9zdG9wd29yZHNcIjtcbmltcG9ydCB7IGdldFB1bmN0dWF0aW9uIH0gZnJvbSBcIi4vcHVuY3R1YXRpb25cIjtcblxuZXhwb3J0IGNsYXNzIEJNMjVFbmNvZGVyIHtcbiAgcHJpdmF0ZSBwcm9wczogQk0yNUVuY29kZXJQcm9wcztcbiAgcHJpdmF0ZSBzdG9wd29yZHM6IHN0cmluZ1tdO1xuICBwcml2YXRlIHB1bmN0dWF0aW9uOiBzdHJpbmdbXTtcblxuICBjb25zdHJ1Y3Rvcihwcm9wcz86IEJNMjVFbmNvZGVyQ29uc3RydWN0b3JQcm9wcykge1xuICAgIHRoaXMucHJvcHMgPSB7XG4gICAgICBiOiBwcm9wcz8uYiA/PyAwLjc1LFxuICAgICAgazE6IHByb3BzPy5rMSA/PyAxLjIsXG4gICAgICBsb3dlckNhc2U6IHByb3BzPy5sb3dlckNhc2UgPz8gdHJ1ZSxcbiAgICAgIHJlbW92ZVB1bmN0dWF0aW9uOiBwcm9wcz8ucmVtb3ZlUHVuY3R1YXRpb24gPz8gdHJ1ZSxcbiAgICAgIHJlbW92ZVN0b3B3b3JkczogcHJvcHM/LnJlbW92ZVN0b3B3b3JkcyA/PyB0cnVlLFxuICAgICAgdG9rZW5pemVyOiBwcm9wcz8udG9rZW5pemVyID8/IG5ldyBUb2tlbml6ZXIoKSxcbiAgICAgIGRvY0ZyZXE6IHt9LFxuICAgICAgbkRvY3M6IDAsXG4gICAgICBhdmdkbDogMCxcbiAgICB9O1xuICAgIHRoaXMuc3RvcHdvcmRzID0gZ2V0U3RvcHdvcmRzKCk7XG4gICAgdGhpcy5wdW5jdHVhdGlvbiA9IGdldFB1bmN0dWF0aW9uKCk7XG4gIH1cblxuICBmaXQoY29ycHVzOiBzdHJpbmdbXSk6IEJNMjVFbmNvZGVyIHtcbiAgICBsZXQgbkRvY3MgPSAwO1xuICAgIGxldCBzdW1Eb2NMZW4gPSAwO1xuICAgIGNvbnN0IGRvY0ZyZXFDb3VudGVyOiB7IFt0b2tlbjogc3RyaW5nXTogbnVtYmVyIH0gPSB7fTtcblxuICAgIGZvciAoY29uc3QgZG9jIG9mIGNvcnB1cykge1xuICAgICAgaWYgKHR5cGVvZiBkb2MgIT09IFwic3RyaW5nXCIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiY29ycHVzIG11c3QgYmUgYSBsaXN0IG9mIHN0cmluZ3NcIik7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHsgaW5kaWNlcywgdGYgfSA9IHRoaXMudGYoZG9jKTtcbiAgICAgIGlmIChpbmRpY2VzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIG5Eb2NzICs9IDE7XG4gICAgICBzdW1Eb2NMZW4gKz0gdGYucmVkdWNlKChzdW0sIGZyZXEpID0+IHN1bSArIGZyZXEsIDApO1xuXG4gICAgICAvLyBDb3VudCB0aGUgbnVtYmVyIG9mIGRvY3VtZW50cyB0aGF0IGNvbnRhaW4gZWFjaCB0b2tlblxuICAgICAgZm9yIChjb25zdCBpbmRleCBvZiBpbmRpY2VzKSB7XG4gICAgICAgIGRvY0ZyZXFDb3VudGVyW2luZGV4XSA9IChkb2NGcmVxQ291bnRlcltpbmRleF0gfHwgMCkgKyAxO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMucHJvcHMuZG9jRnJlcSA9IGRvY0ZyZXFDb3VudGVyO1xuICAgIHRoaXMucHJvcHMubkRvY3MgPSBuRG9jcztcbiAgICB0aGlzLnByb3BzLmF2Z2RsID0gc3VtRG9jTGVuIC8gbkRvY3M7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBlbmNvZGUoaW5wdXQ6IHN0cmluZyk6IHsgaW5kaWNlczogbnVtYmVyW107IHZhbHVlczogbnVtYmVyW10gfSB7XG4gICAgaWYgKFxuICAgICAgIU9iamVjdC5rZXlzKHRoaXMucHJvcHMuZG9jRnJlcSkubGVuZ3RoIHx8XG4gICAgICAhdGhpcy5wcm9wcy5uRG9jcyB8fFxuICAgICAgIXRoaXMucHJvcHMuYXZnZGxcbiAgICApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkJNMjVFbmNvZGVyIGhhcyBub3QgYmVlbiBmaXR0ZWQgeWV0XCIpO1xuICAgIH1cblxuICAgIGNvbnN0IHsgaW5kaWNlcywgdGY6IGRvY1RmIH0gPSB0aGlzLnRmKGlucHV0KTtcbiAgICBjb25zdCB0ZiA9IFsuLi5kb2NUZl07XG4gICAgY29uc3QgdGZTdW0gPSB0Zi5yZWR1Y2UoKHN1bSwgZnJlcSkgPT4gc3VtICsgZnJlcSwgMCk7XG4gICAgY29uc3QgdGZOb3JtZWQgPSB0Zi5tYXAoXG4gICAgICAodCkgPT5cbiAgICAgICAgdCAvXG4gICAgICAgICh0aGlzLnByb3BzLmsxICpcbiAgICAgICAgICAoMS4wIC0gdGhpcy5wcm9wcy5iICsgdGhpcy5wcm9wcy5iICogKHRmU3VtIC8gdGhpcy5wcm9wcy5hdmdkbCkpICtcbiAgICAgICAgICB0KVxuICAgICk7XG5cbiAgICByZXR1cm4ge1xuICAgICAgaW5kaWNlcyxcbiAgICAgIHZhbHVlczogdGZOb3JtZWQsXG4gICAgfTtcbiAgfVxuXG4gIGVuY29kZVF1ZXJ5KGlucHV0OiBzdHJpbmcpOiB7IGluZGljZXM6IG51bWJlcltdOyB2YWx1ZXM6IG51bWJlcltdIH0ge1xuICAgIGlmIChcbiAgICAgICFPYmplY3Qua2V5cyh0aGlzLnByb3BzLmRvY0ZyZXEpLmxlbmd0aCB8fFxuICAgICAgIXRoaXMucHJvcHMubkRvY3MgfHxcbiAgICAgICF0aGlzLnByb3BzLmF2Z2RsXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCTTI1RW5jb2RlciBoYXMgbm90IGJlZW4gZml0dGVkIHlldFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IGluZGljZXMsIHRmOiBxdWVyeVRmIH0gPSB0aGlzLnRmKGlucHV0KTtcblxuICAgIGNvbnN0IGRmID0gaW5kaWNlcy5tYXAoKGlkeCkgPT4gdGhpcy5wcm9wcy5kb2NGcmVxW2lkeF0gfHwgMSk7XG4gICAgY29uc3QgaWRmID0gZGYubWFwKChkKSA9PiBNYXRoLmxvZygodGhpcy5wcm9wcy5uRG9jcyArIDEpIC8gKGQgKyAwLjUpKSk7XG4gICAgY29uc3QgaWRmU3VtID0gaWRmLnJlZHVjZSgoc3VtLCB2YWwpID0+IHN1bSArIHZhbCwgMCk7XG4gICAgY29uc3QgaWRmTm9ybSA9IGlkZi5tYXAoKHZhbCkgPT4gdmFsIC8gaWRmU3VtKTtcblxuICAgIHJldHVybiB7XG4gICAgICBpbmRpY2VzLFxuICAgICAgdmFsdWVzOiBpZGZOb3JtLFxuICAgIH07XG4gIH1cblxuICBkdW1wKHBhdGg6IHN0cmluZykge1xuICAgIHdyaXRlRmlsZVN5bmMocGF0aCwgSlNPTi5zdHJpbmdpZnkodGhpcy5nZXRQYXJhbXMoKSkpO1xuICB9XG5cbiAgbG9hZChwYXRoOiBzdHJpbmcpIHtcbiAgICB0aGlzLnNldFBhcmFtcyhcbiAgICAgIGJtMjVFbmNvZGVyU2VyaWFsaXplZFNjaGVtYS52YWxpZGF0ZVN5bmMoXG4gICAgICAgIEpTT04ucGFyc2UocmVhZEZpbGVTeW5jKHBhdGgsIFwidXRmLThcIikpXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIGdldFBhcmFtcygpOiBCTTI1RW5jb2RlclNlcmlhbGl6ZWQge1xuICAgIGlmIChcbiAgICAgICFPYmplY3Qua2V5cyh0aGlzLnByb3BzLmRvY0ZyZXEpLmxlbmd0aCB8fFxuICAgICAgIXRoaXMucHJvcHMubkRvY3MgfHxcbiAgICAgICF0aGlzLnByb3BzLmF2Z2RsXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJCTTI1RW5jb2RlciBoYXMgbm90IGJlZW4gZml0dGVkIHlldFwiKTtcbiAgICB9XG5cbiAgICBjb25zdCB7IHRva2VuaXplcjogXywgLi4ucHJvcHNFeGNsVG9rZW5pemVyIH0gPSB0aGlzLnByb3BzO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIC4uLnByb3BzRXhjbFRva2VuaXplcixcbiAgICAgIGRvY0ZyZXE6IHtcbiAgICAgICAgaW5kaWNlczogT2JqZWN0LmtleXModGhpcy5wcm9wcy5kb2NGcmVxKS5tYXAoTnVtYmVyKSxcbiAgICAgICAgdmFsdWVzOiBPYmplY3QudmFsdWVzKHRoaXMucHJvcHMuZG9jRnJlcSksXG4gICAgICB9LFxuICAgIH07XG4gIH1cblxuICBzZXRQYXJhbXMocHJvcHM6IEJNMjVFbmNvZGVyU2VyaWFsaXplZCk6IEJNMjVFbmNvZGVyIHtcbiAgICB0aGlzLnByb3BzID0ge1xuICAgICAgLi4udGhpcy5wcm9wcyxcbiAgICAgIC4uLnByb3BzLFxuICAgIH07XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICBwcml2YXRlIHRmKHRleHQ6IHN0cmluZyk6IHsgaW5kaWNlczogbnVtYmVyW107IHRmOiBudW1iZXJbXSB9IHtcbiAgICBjb25zdCBjb3VudHM6IHsgW3Rva2VuOiBudW1iZXJdOiBudW1iZXIgfSA9IHt9O1xuICAgIGNvbnN0IHRva2VucyA9IHRoaXMucHJvcHMudG9rZW5pemVyXG4gICAgICAudG9rZW5pemUodGhpcy5wcm9wcy5sb3dlckNhc2UgPyB0ZXh0LnRvTG9jYWxlTG93ZXJDYXNlKCkgOiB0ZXh0KVxuICAgICAgLmZpbHRlcigodG9rZW4pID0+XG4gICAgICAgIHRoaXMucHJvcHMucmVtb3ZlU3RvcHdvcmRzID8gIXRoaXMuc3RvcHdvcmRzLmluY2x1ZGVzKHRva2VuKSA6IHRydWVcbiAgICAgIClcbiAgICAgIC5maWx0ZXIoKHRva2VuKSA9PlxuICAgICAgICB0aGlzLnByb3BzLnJlbW92ZVB1bmN0dWF0aW9uID8gIXRoaXMucHVuY3R1YXRpb24uaW5jbHVkZXModG9rZW4pIDogdHJ1ZVxuICAgICAgKTtcblxuICAgIGZvciAoY29uc3QgdG9rZW4gb2YgdG9rZW5zKSB7XG4gICAgICBjb25zdCBoYXNoZWRUb2tlbiA9IHRoaXMuaGFzaFRleHQodG9rZW4pO1xuICAgICAgY291bnRzW2hhc2hlZFRva2VuXSA9IChjb3VudHNbaGFzaGVkVG9rZW5dIHx8IDApICsgMTtcbiAgICB9XG5cbiAgICBjb25zdCBpdGVtcyA9IE9iamVjdC5lbnRyaWVzKGNvdW50cyk7XG4gICAgY29uc3QgaW5kaWNlcyA9IGl0ZW1zLm1hcCgoW2lkeF0pID0+IHBhcnNlSW50KGlkeCwgMTApKTtcbiAgICBjb25zdCB0ZiA9IE9iamVjdC52YWx1ZXMoY291bnRzKTtcblxuICAgIHJldHVybiB7IGluZGljZXMsIHRmIH07XG4gIH1cblxuICBwcml2YXRlIGhhc2hUZXh0KHRva2VuOiBzdHJpbmcpOiBudW1iZXIge1xuICAgIHJldHVybiBtbTModG9rZW4pO1xuICB9XG59XG4iXX0=
